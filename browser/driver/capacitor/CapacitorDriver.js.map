{"version":3,"sources":["../browser/src/driver/capacitor/CapacitorDriver.ts"],"names":[],"mappings":"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","file":"CapacitorDriver.js","sourcesContent":["import { AbstractSqliteDriver } from \"../sqlite-abstract/AbstractSqliteDriver\";\r\nimport { CapacitorConnectionOptions } from \"./CapacitorConnectionOptions\";\r\nimport { CapacitorQueryRunner } from \"./CapacitorQueryRunner\";\r\nimport { QueryRunner } from \"../../query-runner/QueryRunner\";\r\nimport { Connection } from \"../../connection/Connection\";\r\nimport {\r\n    DriverOptionNotSetError,\r\n    DriverPackageNotInstalledError,\r\n} from \"../../error\";\r\nimport { ReplicationMode } from \"../types/ReplicationMode\";\r\n\r\nexport class CapacitorDriver extends AbstractSqliteDriver {\r\n    driver: any;\r\n    options: CapacitorConnectionOptions;\r\n\r\n    // -------------------------------------------------------------------------\r\n    // Constructor\r\n    // -------------------------------------------------------------------------\r\n\r\n    constructor(connection: Connection) {\r\n        super(connection);\r\n\r\n        this.database = this.options.database;\r\n        this.driver = this.options.driver;\r\n\r\n        // validate options to make sure everything is set\r\n        if (!this.options.database)\r\n            throw new DriverOptionNotSetError(\"database\");\r\n\r\n        if (!this.options.driver) throw new DriverOptionNotSetError(\"driver\");\r\n\r\n        // load sqlite package\r\n        this.sqlite = this.options.driver;\r\n    }\r\n\r\n    // -------------------------------------------------------------------------\r\n    // Public Methods\r\n    // -------------------------------------------------------------------------\r\n\r\n    /**\r\n     * Performs connection to the database.\r\n     */\r\n    async connect(): Promise<void> {\r\n        this.databaseConnection = this.createDatabaseConnection();\r\n        await this.databaseConnection;\r\n    }\r\n\r\n    /**\r\n     * Closes connection with database.\r\n     */\r\n    async disconnect(): Promise<void> {\r\n        this.queryRunner = undefined;\r\n        const databaseConnection = await this.databaseConnection;\r\n        return databaseConnection.close().then(() => {\r\n            this.databaseConnection = undefined;\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Creates a query runner used to execute database queries.\r\n     */\r\n    createQueryRunner(mode: ReplicationMode): QueryRunner {\r\n        if (!this.queryRunner)\r\n            this.queryRunner = new CapacitorQueryRunner(this);\r\n\r\n        return this.queryRunner;\r\n    }\r\n\r\n    // -------------------------------------------------------------------------\r\n    // Protected Methods\r\n    // -------------------------------------------------------------------------\r\n\r\n    /**\r\n     * Creates connection with the database.\r\n     */\r\n    protected async createDatabaseConnection() {\r\n        const databaseMode = this.options.mode || \"no-encryption\";\r\n        const isDatabaseEncryted = databaseMode !== \"no-encryption\";\r\n        const databaseVersion =\r\n            typeof this.options.version === \"undefined\"\r\n                ? 1\r\n                : this.options.version;\r\n        const connection = await this.sqlite.createConnection(\r\n            this.options.database,\r\n            isDatabaseEncryted,\r\n            databaseMode,\r\n            databaseVersion\r\n        );\r\n        await connection.open();\r\n\r\n        // we need to enable foreign keys in sqlite to make sure all foreign key related features\r\n        // working properly. this also makes onDelete to work with sqlite.\r\n        await connection.query(`PRAGMA foreign_keys = ON`);\r\n\r\n        if (\r\n            this.options.journalMode &&\r\n            [\"DELETE\", \"TRUNCATE\", \"PERSIST\", \"MEMORY\", \"WAL\", \"OFF\"].indexOf(\r\n                this.options.journalMode\r\n            ) !== -1\r\n        ) {\r\n            await connection.query(\r\n                `PRAGMA journal_mode = ${this.options.journalMode}`\r\n            );\r\n        }\r\n\r\n        return connection;\r\n    }\r\n\r\n    protected loadDependencies(): void {\r\n        this.sqlite = this.driver;\r\n        if (!this.driver) {\r\n            throw new DriverPackageNotInstalledError(\r\n                \"Capacitor\",\r\n                \"@capacitor-community/sqlite\"\r\n            );\r\n        }\r\n    }\r\n}\r\n"],"sourceRoot":"../.."}