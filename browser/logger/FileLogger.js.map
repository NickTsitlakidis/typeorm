{"version":3,"sources":["../browser/src/logger/FileLogger.ts"],"names":[],"mappings":"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","file":"FileLogger.js","sourcesContent":["import { FileLoggerOptions, LoggerOptions } from \"./LoggerOptions\"\r\nimport appRootPath from \"app-root-path\"\r\nimport { QueryRunner } from \"../query-runner/QueryRunner\"\r\nimport { Logger } from \"./Logger\"\r\nimport { PlatformTools } from \"../platform/PlatformTools\"\r\n\r\n/**\r\n * Performs logging of the events in TypeORM.\r\n * This version of logger logs everything into ormlogs.log file.\r\n */\r\nexport class FileLogger implements Logger {\r\n    // -------------------------------------------------------------------------\r\n    // Constructor\r\n    // -------------------------------------------------------------------------\r\n\r\n    constructor(\r\n        private options?: LoggerOptions,\r\n        private fileLoggerOptions?: FileLoggerOptions,\r\n    ) {}\r\n\r\n    // -------------------------------------------------------------------------\r\n    // Public Methods\r\n    // -------------------------------------------------------------------------\r\n\r\n    /**\r\n     * Logs query and parameters used in it.\r\n     */\r\n    logQuery(query: string, parameters?: any[], queryRunner?: QueryRunner) {\r\n        if (\r\n            this.options === \"all\" ||\r\n            this.options === true ||\r\n            (Array.isArray(this.options) &&\r\n                this.options.indexOf(\"query\") !== -1)\r\n        ) {\r\n            const sql =\r\n                query +\r\n                (parameters && parameters.length\r\n                    ? \" -- PARAMETERS: \" + this.stringifyParams(parameters)\r\n                    : \"\")\r\n            this.write(\"[QUERY]: \" + sql)\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Logs query that is failed.\r\n     */\r\n    logQueryError(\r\n        error: string,\r\n        query: string,\r\n        parameters?: any[],\r\n        queryRunner?: QueryRunner,\r\n    ) {\r\n        if (\r\n            this.options === \"all\" ||\r\n            this.options === true ||\r\n            (Array.isArray(this.options) &&\r\n                this.options.indexOf(\"error\") !== -1)\r\n        ) {\r\n            const sql =\r\n                query +\r\n                (parameters && parameters.length\r\n                    ? \" -- PARAMETERS: \" + this.stringifyParams(parameters)\r\n                    : \"\")\r\n            this.write([`[FAILED QUERY]: ${sql}`, `[QUERY ERROR]: ${error}`])\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Logs query that is slow.\r\n     */\r\n    logQuerySlow(\r\n        time: number,\r\n        query: string,\r\n        parameters?: any[],\r\n        queryRunner?: QueryRunner,\r\n    ) {\r\n        const sql =\r\n            query +\r\n            (parameters && parameters.length\r\n                ? \" -- PARAMETERS: \" + this.stringifyParams(parameters)\r\n                : \"\")\r\n        this.write(`[SLOW QUERY: ${time} ms]: ` + sql)\r\n    }\r\n\r\n    /**\r\n     * Logs events from the schema build process.\r\n     */\r\n    logSchemaBuild(message: string, queryRunner?: QueryRunner) {\r\n        if (\r\n            this.options === \"all\" ||\r\n            (Array.isArray(this.options) &&\r\n                this.options.indexOf(\"schema\") !== -1)\r\n        ) {\r\n            this.write(message)\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Logs events from the migrations run process.\r\n     */\r\n    logMigration(message: string, queryRunner?: QueryRunner) {\r\n        this.write(message)\r\n    }\r\n\r\n    /**\r\n     * Perform logging using given logger, or by default to the console.\r\n     * Log has its own level and message.\r\n     */\r\n    log(\r\n        level: \"log\" | \"info\" | \"warn\",\r\n        message: any,\r\n        queryRunner?: QueryRunner,\r\n    ) {\r\n        switch (level) {\r\n            case \"log\":\r\n                if (\r\n                    this.options === \"all\" ||\r\n                    (Array.isArray(this.options) &&\r\n                        this.options.indexOf(\"log\") !== -1)\r\n                )\r\n                    this.write(\"[LOG]: \" + message)\r\n                break\r\n            case \"info\":\r\n                if (\r\n                    this.options === \"all\" ||\r\n                    (Array.isArray(this.options) &&\r\n                        this.options.indexOf(\"info\") !== -1)\r\n                )\r\n                    this.write(\"[INFO]: \" + message)\r\n                break\r\n            case \"warn\":\r\n                if (\r\n                    this.options === \"all\" ||\r\n                    (Array.isArray(this.options) &&\r\n                        this.options.indexOf(\"warn\") !== -1)\r\n                )\r\n                    this.write(\"[WARN]: \" + message)\r\n                break\r\n        }\r\n    }\r\n\r\n    // -------------------------------------------------------------------------\r\n    // Protected Methods\r\n    // -------------------------------------------------------------------------\r\n\r\n    /**\r\n     * Writes given strings into the log file.\r\n     */\r\n    protected write(strings: string | string[]) {\r\n        strings = Array.isArray(strings) ? strings : [strings]\r\n        const basePath = appRootPath.path + \"/\"\r\n        let logPath = \"ormlogs.log\"\r\n        if (this.fileLoggerOptions && this.fileLoggerOptions.logPath) {\r\n            logPath = PlatformTools.pathNormalize(\r\n                this.fileLoggerOptions.logPath,\r\n            )\r\n        }\r\n        strings = (strings as string[]).map(\r\n            (str) => \"[\" + new Date().toISOString() + \"]\" + str,\r\n        )\r\n        PlatformTools.appendFileSync(\r\n            basePath + logPath,\r\n            strings.join(\"\\r\\n\") + \"\\r\\n\",\r\n        ) // todo: use async or implement promises?\r\n    }\r\n\r\n    /**\r\n     * Converts parameters to a string.\r\n     * Sometimes parameters can have circular objects and therefor we are handle this case too.\r\n     */\r\n    protected stringifyParams(parameters: any[]) {\r\n        try {\r\n            return JSON.stringify(parameters)\r\n        } catch (error) {\r\n            // most probably circular objects in parameters\r\n            return parameters\r\n        }\r\n    }\r\n}\r\n"],"sourceRoot":".."}